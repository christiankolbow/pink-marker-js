"use strict";const defaultOptions={modalClass:"",modalTextareaClass:"",modalButtonContainerClass:"",saveButtonClass:"",cancelButtonClass:"",deleteButtonClass:"",saveButtonText:"Save",cancelButtonText:"Cancel",deleteButtonText:"Delete",overlayColor:"rgba(255,105,180,0.5)",iconClass:"",iconContainerClass:"",iconContainerTitle:"Click to open modal",defaultIcon:"./icon.svg"};class PinkMarker{constructor(t){this.annotations=[],this.updateAnnotations=()=>{this.removeAnnotation(),this.annotations.forEach((t=>{this.highlightSelectionFromEncoding(t.encoding),this.attachIcon(t.encoding,t.icon)}))},this.options=Object.assign(Object.assign({},defaultOptions),t)}init(){document.addEventListener("mouseup",(()=>{const t=window.getSelection();if(t&&t.toString().trim()){const t=this.encodeSelection();t&&(this.showModal(t,"",(e=>{this.annotations.push({encoding:t,note:e,icon:this.options.defaultIcon})})),this.highlightSelectionFromEncoding(t),this.attachIcon(t,this.options.defaultIcon))}})),window.addEventListener("resize",this.updateAnnotations),window.addEventListener("orientationchange",this.updateAnnotations)}createTextNodeIndexMap(t=document.body){const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT),n=[];for(;e.nextNode();)n.push(e.currentNode);return n}encodeNumber(t){return this.toBase52Char(Math.floor(t/52))+this.toBase52Char(t%52)}toBase52Char(t){return t<26?String.fromCharCode(65+t):String.fromCharCode(97+t-26)}decodeNumber(t){if(2!==t.length)throw new Error("decodeNumber expects a string of length 2");return 52*this.fromBase52Char(t.charAt(0))+this.fromBase52Char(t.charAt(1))}fromBase52Char(t){const e=t.charCodeAt(0);if(e>=65&&e<91)return e-65;if(e>=97&&e<123)return e-97+26;throw new Error("Invalid character for Base52: "+t)}getFirstTextNode(t){if(t.nodeType===Node.TEXT_NODE)return t;for(let e=0;e<t.childNodes.length;e++){const n=this.getFirstTextNode(t.childNodes[e]);if(n)return n}return null}getLastTextNodeFrom(t){if(t.nodeType===Node.TEXT_NODE)return t;for(let e=t.childNodes.length-1;e>=0;e--){const n=this.getLastTextNodeFrom(t.childNodes[e]);if(n)return n}return null}getLastTextNodeBefore(t){let e=t.previousSibling;for(;e;){if(e.nodeType===Node.TEXT_NODE)return e;const t=this.getLastTextNodeFrom(e);if(t)return t;e=e.previousSibling}return null}encodeSelection(){const t=window.getSelection();if(!t||0===t.rangeCount)return null;const e=t.getRangeAt(0);if(e.startContainer.nodeType!==Node.TEXT_NODE){const t=this.getFirstTextNode(e.startContainer);if(!t)return null;e.setStart(t,0)}if(e.endContainer.nodeType!==Node.TEXT_NODE){const t=this.getLastTextNodeBefore(e.endContainer);if(!t)return null;{const n=t.textContent?t.textContent.length:0;e.setEnd(t,n)}}const n=this.createTextNodeIndexMap(document.body),o=n.indexOf(e.startContainer),i=n.indexOf(e.endContainer);return-1===o||-1===i?null:"!{"+this.encodeNumber(o)+this.encodeNumber(e.startOffset)+this.encodeNumber(i)+this.encodeNumber(e.endOffset)+"}"}decodeSelection(t){if(!t.startsWith("!{")||!t.endsWith("}"))return null;const e=t.slice(2,-1);if(8!==e.length)return null;const n=this.decodeNumber(e.slice(0,2)),o=this.decodeNumber(e.slice(2,4)),i=this.decodeNumber(e.slice(4,6)),s=this.decodeNumber(e.slice(6,8)),r=this.createTextNodeIndexMap(document.body),a=r[n],c=r[i];if(!a||!c)return null;const l=document.createRange();try{l.setStart(a,o),l.setEnd(c,s)}catch(t){return null}return l}filterRects(t){return t.filter((e=>!t.some((t=>e!==t&&(e.left>=t.left&&e.top>=t.top&&e.right<=t.right&&e.bottom<=t.bottom)))))}highlightRange(t){const e=Array.from(t.getClientRects());this.filterRects(e).forEach((t=>{const e=document.createElement("div");e.className="pink-marker-overlay",e.style.position="absolute",e.style.top=`${t.top+window.scrollY}px`,e.style.left=`${t.left+window.scrollX}px`,e.style.width=`${t.width}px`,e.style.height=`${t.height}px`,e.style.backgroundColor=this.options.overlayColor,e.style.pointerEvents="none",document.body.appendChild(e)}))}removeAnnotation(){document.querySelectorAll(".pink-marker-overlay").forEach((t=>t.remove())),document.querySelectorAll(".annotation-icon").forEach((t=>t.remove()))}highlightSelectionFromEncoding(t){const e=this.decodeSelection(t);e&&this.highlightRange(e)}showModal(t,e,n){let o=document.getElementById(t);if(!o){o=document.createElement("div"),o.id=t,o.className=this.options.modalClass||"",o.style.position="fixed",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.zIndex="2000";const e=document.createElement("textarea");e.id="annotation-text",e.className=this.options.modalTextareaClass||"",o.appendChild(e);const s=document.createElement("div");s.className=this.options.modalButtonContainerClass||"";const r=document.createElement("button");r.className=this.options.saveButtonClass||"",r.textContent=this.options.saveButtonText,r.addEventListener("click",(()=>{n(document.getElementById("annotation-text").value),o.remove(),document.removeEventListener("click",i)}));const a=document.createElement("button");a.className=this.options.cancelButtonClass||"",a.textContent=this.options.cancelButtonText,a.addEventListener("click",(()=>{o.remove(),document.removeEventListener("click",i),this.updateAnnotations()}));const c=document.createElement("button");c.className=this.options.deleteButtonClass||"",c.textContent=this.options.deleteButtonText,c.addEventListener("click",(()=>{const e=this.annotations.findIndex((e=>e.encoding===t));-1!==e&&this.annotations.splice(e,1),o.remove(),document.removeEventListener("click",i),this.updateAnnotations()})),s.append(r,a,c),o.appendChild(s),document.body.appendChild(o)}o.style.display="block",setTimeout((()=>{document.getElementById("annotation-text").value=e||"",document.getElementById("annotation-text").focus()}),0);const i=t=>{o&&!o.contains(t.target)&&(o.remove(),document.removeEventListener("click",i))};setTimeout((()=>{document.addEventListener("click",i)}),0)}attachIcon(t,e){const n=this.decodeSelection(t);if(!n)return;const o=n.getBoundingClientRect(),i=document.createElement("div"),s=document.createElement("img");i.className=`${this.options.iconContainerClass} annotation-icon`||"annotation-icon",s.className=this.options.iconClass||"",s.src=e,s.style.width="20px",s.style.height="20px",i.style.position="absolute",i.style.top=o.top+window.scrollY-10+"px",i.style.left=o.left+window.scrollX+o.width-10+"px",i.style.cursor="pointer",i.title=this.options.iconContainerTitle,i.addEventListener("click",(()=>{var e;const n=(null===(e=this.annotations.find((e=>e.encoding===t)))||void 0===e?void 0:e.note)||"";this.showModal(t,n,(e=>{const n=this.annotations.find((e=>e.encoding===t));n&&(n.note=e)}))})),i.appendChild(s),document.body.appendChild(i)}}